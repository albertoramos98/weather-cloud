<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clima & Marés</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { 
      --primary: #145faa;
      --primary-dark: #145faa;
      --secondary: #764ba2;
      --accent: #f093fb;
      --ocean: #00d4ff;
      --ocean-dark: #00b8e6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1a202c;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Poppins', sans-serif; 
      background: linear-gradient(135deg, #061850 20%, #85daf5 100%);
      min-height: 100vh;
      color: var(--gray-800);
      line-height: 1.6;
    }

    .app-container {
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .main-content {
      max-width: 160vh;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }

    .tabs-container {
      background: var(--gray-50);
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      max-width: 300px;
      margin: 0 auto;
      background: white;
      padding: 0.25rem;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .tab-button {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      color: var(--gray-600);
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .tab-button:hover {
      background: var(--gray-100);
      color: var(--gray-800);
    }

    .tab-button.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .content-wrapper {
      padding: 0;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Layout original do clima */
    .clima-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      min-height: 600px;
    }

    .clima-left {
      padding: 2rem;
      border-right: 1px solid var(--gray-200);
    }

    .clima-right {
      padding: 2rem;
      background: var(--gray-50);
    }

    /* Layout das marés seguindo o mesmo padrão */
    .mare-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      min-height: 600px;
    }

    .mare-left {
      padding: 2rem;
      border-right: 1px solid var(--gray-200);
    }

    .mare-right {
      padding: 2rem;
      background: var(--gray-50);
    }

    .form-container {
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      border: 1px solid var(--gray-200);
    }

    .search-container {
      display: flex;
      gap: 1rem;
      align-items: end;
    }

    .search-container .input-group {
      flex: 1;
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: white;
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(20, 95, 170, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-ocean {
      background: linear-gradient(135deg, var(--ocean) 0%, var(--ocean-dark) 100%);
      color: white;
    }

    .btn-ocean:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .map-container {
      background: white;
      border-radius: 16px;
      padding: 1rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }

    .map-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    #map, #map-mare {
      height: 300px;
      border-radius: 8px;
      border: 1px solid var(--gray-200);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
      color: var(--gray-600);
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      display: none;
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #fecaca;
      margin-bottom: 1rem;
    }

    .error-message.active {
      display: block;
    }

    .resultado-clima-desktop {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }

    .weather-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    .weather-location {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .weather-icon {
      width: 80px;
      height: 80px;
    }

    .temperature {
      font-size: 3rem;
      font-weight: 700;
      color: var(--primary);
    }

    .weather-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .detail-icon {
      width: 20px;
      height: 20px;
      color: var(--primary);
    }

    /* Controles de marés */
    .mare-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .mare-generate-btn {
      grid-column: 1 / -1;
      justify-self: start;
    }

    /* Gráfico otimizado */
    .mare-chart-container {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      margin-bottom: 1.5rem;
    }

    .mare-chart-header {
      margin-bottom: 1rem;
    }

    .mare-chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.25rem;
    }

    .mare-chart-subtitle {
      color: var(--gray-600);
      font-size: 0.85rem;
    }

    #mares-chart {
      width: 100%;
      height: 250px !important;
      max-height: 250px;
    }

    /* Tabela compacta */
    .mare-table-container {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      margin-bottom: 1.5rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .mare-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .mare-table th,
    .mare-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .mare-table th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-700);
      position: sticky;
      top: 0;
    }

    .mare-table tr:hover {
      background: var(--gray-50);
    }

    .mare-alta {
      color: var(--danger);
      font-weight: 600;
    }

    .mare-baixa {
      color: var(--primary);
      font-weight: 600;
    }

    /* Alertas compactos */
    .alertas-container {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      margin-bottom: 1.5rem;
    }

    .alerta {
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid;
      font-size: 0.9rem;
    }

    .alerta-baixo {
      background: #f0fdf4;
      border-color: var(--success);
      color: #166534;
    }

    .alerta-moderado {
      background: #fffbeb;
      border-color: var(--warning);
      color: #92400e;
    }

    .alerta-alto {
      background: #fef2f2;
      border-color: var(--danger);
      color: #dc2626;
    }

    .alerta-titulo {
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .alerta-descricao {
      line-height: 1.4;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .app-container {
        padding: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .clima-layout, .mare-layout {
        grid-template-columns: 1fr;
      }

      .clima-left, .mare-left {
        border-right: none;
        border-bottom: 1px solid var(--gray-200);
      }

      .clima-right, .mare-right {
        background: white;
      }

      .search-container {
        flex-direction: column;
        align-items: stretch;
      }

      .mare-controls {
        grid-template-columns: 1fr;
      }

      .weather-details {
        grid-template-columns: 1fr;
      }
    }

    /* Animações suaves */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>
        <i class="fas fa-cloud-sun"></i>
        CliMar
      </h1>
      <p>Informações meteorológicas e oceanográficas em tempo real</p>
    </div>

    <div class="main-content">
      <div class="tabs-container">
        <div class="tabs">
          <button class="tab-button active" onclick="showTab('clima')">
            <i class="fas fa-thermometer-half"></i>
            Clima
          </button>
          <button class="tab-button" onclick="showTab('mare')">
            <i class="fas fa-water"></i>
            Marés
          </button>
        </div>
      </div>

      <div class="content-wrapper">
        <!-- Seção Clima (LAYOUT ORIGINAL MANTIDO) -->
        <div id="clima" class="tab-content active">
          <div class="clima-layout">
            <div class="clima-left">
              <div class="form-container">
                <form id="clima-form">
                  <div class="search-container">
                    <div class="input-group">
                      <label for="cidade">Localização</label>
                      <input type="text" id="cidade" name="cidade" placeholder="Digite o nome da cidade" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-search"></i>
                      Buscar
                    </button>
                  </div>
                </form>
              </div>

              <div class="map-container">
                <div class="map-header">
                  <i class="fas fa-map-marker-alt"></i>
                  Clique no mapa para ver o clima local
                </div>
                <div id="map"></div>
              </div>
            </div>

            <div class="clima-right">
              <div class="loading" id="loading-clima">
                <div class="spinner"></div>
                <p>Carregando informações do clima...</p>
              </div>
              <div class="error-message" id="error-clima"></div>
              <div id="resultado-clima" class="resultado-clima-desktop"></div>
            </div>
          </div>
        </div>

        <!-- Seção Marés (MESMO LAYOUT DO CLIMA) -->
        <div id="mare" class="tab-content">
          <div class="mare-layout">
            <div class="mare-left">
              <div class="form-container">
                <div class="mare-controls">
                  <div class="input-group">
                    <label for="cidade-mare">Localização</label>
                    <input type="text" id="cidade-mare" name="cidade-mare" placeholder="Digite a cidade" required>
                  </div>
                  <div class="input-group">
                    <label for="mes-mare">Mês</label>
                    <select id="mes-mare" name="mes-mare" required>
                      <option value="">Selecione o mês</option>
                      <option value="1">Janeiro 2025</option>
                      <option value="2">Fevereiro 2025</option>
                      <option value="3">Março 2025</option>
                      <option value="4">Abril 2025</option>
                      <option value="5">Maio 2025</option>
                      <option value="6">Junho 2025</option>
                      <option value="7">Julho 2025</option>
                      <option value="8">Agosto 2025</option>
                      <option value="9">Setembro 2025</option>
                      <option value="10">Outubro 2025</option>
                      <option value="11">Novembro 2025</option>
                      <option value="12">Dezembro 2025</option>
                    </select>
                  </div>
                  <button type="button" id="gerar-tabua" class="btn btn-ocean mare-generate-btn">
                    <i class="fas fa-chart-line"></i>
                    Gerar Tábua
                  </button>
                </div>
              </div>

              <div class="map-container">
                <div class="map-header">
                  <i class="fas fa-map-marker-alt"></i>
                  Clique no mapa para selecionar localização
                </div>
                <div id="map-mare"></div>
              </div>
            </div>

            <div class="mare-right">
              <div class="loading" id="loading-mare">
                <div class="spinner"></div>
                <p>Gerando tábua de marés...</p>
              </div>
              <div class="error-message" id="error-mare"></div>

              <!-- Alertas de Alagamento -->
              <div id="alertas-container" class="alertas-container" style="display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--gray-800); font-size: 1.1rem;">
                  <i class="fas fa-exclamation-triangle"></i>
                  Alertas de Alagamento
                </h3>
                <div id="alertas-content"></div>
              </div>

              <!-- Gráfico da Tábua de Marés -->
              <div id="chart-container" class="mare-chart-container" style="display: none;">
                <div class="mare-chart-header">
                  <h3 class="mare-chart-title">Tábua de Marés</h3>
                  <p class="mare-chart-subtitle" id="chart-subtitle">Dados REAIS de marés</p>
                </div>
                <canvas id="mares-chart"></canvas>
              </div>

              <!-- Tabela de Dados Detalhados -->
              <div id="table-container" class="mare-table-container" style="display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--gray-800); font-size: 1.1rem;">
                  <i class="fas fa-table"></i>
                  Dados Detalhados
                </h3>
                <table class="mare-table">
                  <thead>
                    <tr>
                      <th>Dia</th>
                      <th>Alta</th>
                      <th>Hora</th>
                      <th>Baixa</th>
                      <th>Hora</th>
                    </tr>
                  </thead>
                  <tbody id="mare-table-body">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- VARIÁVEIS GLOBAIS ---
    let map = null;
    let mapMare = null;
    let currentChart = null;
    let currentMarker = null;
    let currentMarkerMare = null;
    let cidadeSelecionada = null;
    let coordenadasSelecionadas = null;

    // --- FUNÇÕES DE NAVEGAÇÃO ---
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
      
      // Inicializar mapas se necessário
      if (tabName === 'clima' && !map) {
        setTimeout(() => initMap(), 100);
      } else if (tabName === 'mare' && !mapMare) {
        setTimeout(() => initMapMare(), 100);
      }
    }

    // --- FUNÇÕES DE CLIMA (MANTIDAS ORIGINAIS) ---
    function initMap() {
      if (map) return;
      
      map = L.map("map").setView([-15.78, -47.92], 4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { 
        attribution: "© OpenStreetMap",
        maxZoom: 18
      }).addTo(map);

      map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        
        if (currentMarker) {
          map.removeLayer(currentMarker);
        }
        
        currentMarker = L.marker([lat, lon]).addTo(map)
          .bindPopup(`Coordenadas: ${lat.toFixed(4)}, ${lon.toFixed(4)}`)
          .openPopup();
        
        fetchClima(`/clima?lat=${lat}&lon=${lon}`);
        
        fetch(`/clima?lat=${lat}&lon=${lon}`)
          .then(response => response.json())
          .then(data => {
            if (data.cidade) {
              document.getElementById('cidade').value = data.cidade;
            }
          })
          .catch(err => console.error('Erro ao buscar cidade:', err));
      });
    }

    const showLoadingClima = show => { 
      document.getElementById('loading-clima').classList.toggle('active', show); 
      if (show) { 
        document.getElementById('error-clima').classList.remove('active'); 
        document.getElementById('resultado-clima').style.display = 'none';
      }
    };

    const showErrorClima = message => { 
      document.getElementById('error-clima').textContent = message; 
      document.getElementById('error-clima').classList.add('active'); 
      showLoadingClima(false); 
    };

    async function fetchClima(url) {
        showLoadingClima(true);
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (!response.ok) throw new Error(data.erro || 'Erro desconhecido');
            exibirDadosClima(data);
            atualizarMapa(data.latitude, data.longitude, data.cidade);
        } catch (error) {
            showErrorClima(error.message);
        } finally {
            showLoadingClima(false);
        }
    }

    function exibirDadosClima(data) {
      const resultado = document.getElementById('resultado-clima');
      
      let mareHtml = '';
      if (data.mare) {
        let maresAltasHtml = '';
        if (data.mare.mare_alta && data.mare.mare_alta.length > 0) {
          maresAltasHtml = data.mare.mare_alta.map(mare => 
            `<div class="detail-item">
              <span>${mare.hora}</span>
              <span class="mare-alta">${mare.altura_m}m</span>
            </div>`
          ).join('');
        }
        
        let maresBaixasHtml = '';
        if (data.mare.mare_baixa && data.mare.mare_baixa.length > 0) {
          maresBaixasHtml = data.mare.mare_baixa.map(mare => 
            `<div class="detail-item">
              <span>${mare.hora}</span>
              <span class="mare-baixa">${mare.altura_m}m</span>
            </div>`
          ).join('');
        }
        
        mareHtml = `
          <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 12px;">
            <h3 style="margin-bottom: 1rem; color: var(--gray-800);">
              <i class="fas fa-water"></i>
              Informações de Marés - ${data.mare.local}
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <h4 style="margin-bottom: 0.5rem; color: var(--danger);">
                  <i class="fas fa-arrow-up"></i>
                  Marés Altas
                </h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  ${maresAltasHtml || '<p style="color: var(--gray-600);">Nenhuma maré alta registrada</p>'}
                </div>
              </div>
              <div>
                <h4 style="margin-bottom: 0.5rem; color: var(--primary);">
                  <i class="fas fa-arrow-down"></i>
                  Marés Baixas
                </h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  ${maresBaixasHtml || '<p style="color: var(--gray-600);">Nenhuma maré baixa registrada</p>'}
                </div>
              </div>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-600);">
              <i class="fas fa-info-circle"></i>
              Consulte a aba "Marés" para informações específicas.
            </p>
          </div>
        `;
      }
      
      resultado.innerHTML = `
        <div class="weather-header">
          <div class="weather-location">
            <h2>${data.cidade}, ${data.pais}</h2>
            <span style="background: var(--gray-200); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
              ${data.latitude.toFixed(2)}, ${data.longitude.toFixed(2)}
            </span>
          </div>
          <div style="text-align: right;">
            <img src="https://openweathermap.org/img/wn/${data.icone}@2x.png" alt="${data.descricao}" class="weather-icon">
            <div class="temperature">${Math.round(data.temperatura)}°C</div>
          </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 2rem;">
          <p style="font-size: 1.2rem; color: var(--gray-600); text-transform: capitalize;">
            ${data.descricao}
          </p>
          <p style="color: var(--gray-500);">
            Sensação térmica: ${Math.round(data.sensacao)}°C
          </p>
        </div>
        
        <div class="weather-details">
          <div class="detail-item">
            <i class="fas fa-thermometer-half detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Temperatura</div>
              <div style="color: var(--gray-600);">Min: ${Math.round(data.temp_min)}°C | Max: ${Math.round(data.temp_max)}°C</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-tint detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Umidade</div>
              <div style="color: var(--gray-600);">${data.umidade}%</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-gauge detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Pressão</div>
              <div style="color: var(--gray-600);">${data.pressao} hPa</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-wind detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Vento</div>
              <div style="color: var(--gray-600);">${data.vento} m/s</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-cloud detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Nuvens</div>
              <div style="color: var(--gray-600);">${data.nuvens}%</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-eye detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Visibilidade</div>
              <div style="color: var(--gray-600);">${data.visibilidade !== 'N/A' ? (data.visibilidade/1000).toFixed(1) + ' km' : 'N/A'}</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-sun detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Nascer do Sol</div>
              <div style="color: var(--gray-600);">${data.nascer_do_sol}</div>
            </div>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-moon detail-icon"></i>
            <div>
              <div style="font-weight: 500;">Pôr do Sol</div>
              <div style="color: var(--gray-600);">${data.por_do_sol}</div>
            </div>
          </div>
        </div>
        
        ${mareHtml}
      `;
      
      resultado.style.display = 'block';
      resultado.classList.add('fade-in');
    }

    function atualizarMapa(lat, lon, cidade) {
      if (currentMarker) {
        map.removeLayer(currentMarker);
      }
      
      currentMarker = L.marker([lat, lon]).addTo(map)
        .bindPopup(`${cidade}<br>Coordenadas: ${lat.toFixed(4)}, ${lon.toFixed(4)}`)
        .openPopup();
      
      map.setView([lat, lon], 10);
    }

    // --- FUNÇÕES DE MARÉS ---
    function initMapMare() {
      if (mapMare) return;
      
      mapMare = L.map("map-mare").setView([-15.78, -47.92], 4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { 
        attribution: "© OpenStreetMap",
        maxZoom: 18
      }).addTo(mapMare);

      mapMare.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        
        if (currentMarkerMare) {
          mapMare.removeLayer(currentMarkerMare);
        }
        
        currentMarkerMare = L.marker([lat, lon]).addTo(mapMare)
          .bindPopup(`Coordenadas: ${lat.toFixed(4)}, ${lon.toFixed(4)}`)
          .openPopup();
        
        coordenadasSelecionadas = {lat, lon};
        buscarCidadePorCoordenadas(lat, lon);
      });
    }

    function buscarCidadePorCoordenadas(lat, lon) {
      fetch(`/clima?lat=${lat}&lon=${lon}`)
        .then(response => response.json())
        .then(data => {
          if (data.cidade) {
            document.getElementById('cidade-mare').value = data.cidade;
            cidadeSelecionada = data.cidade;
          }
        })
        .catch(err => {
          console.error('Erro ao buscar cidade:', err);
        });
    }

    function gerarTabuaMares() {
      const cidade = document.getElementById('cidade-mare').value;
      const mes = document.getElementById('mes-mare').value;
      
      if (!cidade || !mes) {
        alert('Por favor, selecione uma cidade e um mês');
        return;
      }
      
      const loading = document.getElementById('loading-mare');
      const error = document.getElementById('error-mare');
      
      loading.classList.add('active');
      error.classList.remove('active');
      
      fetch(`/tabua_mares?cidade=${encodeURIComponent(cidade)}&mes=${mes}`)
        .then(response => response.json())
        .then(data => {
          loading.classList.remove('active');
          if (data.erro) {
            error.textContent = data.erro;
            error.classList.add('active');
          } else {
            exibirTabuaMares(data);
            buscarAlertas(cidade);
          }
        })
        .catch(err => {
          loading.classList.remove('active');
          error.textContent = 'Erro ao gerar tábua de marés';
          error.classList.add('active');
          console.error('Erro:', err);
        });
    }

    function exibirTabuaMares(data) {
      document.getElementById('chart-container').style.display = 'block';
      document.getElementById('table-container').style.display = 'block';
      
      document.getElementById('chart-subtitle').textContent = 
        `${data.cidade} - ${getNomeMes(data.mes)} ${data.ano} (${data.total_dias} dias)`;
      
      gerarGraficoMares(data.tabua);
      gerarTabelaMares(data.tabua);
      
      document.getElementById('chart-container').classList.add('slide-up');
      document.getElementById('table-container').classList.add('slide-up');
    }

    function gerarGraficoMares(tabua) {
      const ctx = document.getElementById('mares-chart').getContext('2d');
      
      if (currentChart) {
        currentChart.destroy();
      }

      const dias = tabua.map(item => item.dia);
      const maresAltas = tabua.map(item => item.mare_mais_alta ? item.mare_mais_alta.altura_m : null);
      const maresBaixas = tabua.map(item => item.mare_mais_baixa ? item.mare_mais_baixa.altura_m : null);

      currentChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dias,
          datasets: [{
            label: 'Maré Alta',
            data: maresAltas,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointBackgroundColor: '#ef4444',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 1,
            pointRadius: 3
          }, {
            label: 'Maré Baixa',
            data: maresBaixas,
            borderColor: '#145faa',
            backgroundColor: 'rgba(20, 95, 170, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointBackgroundColor: '#145faa',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 1,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#e5e7eb',
              borderWidth: 1,
              cornerRadius: 6,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  return `Dia ${context[0].label}`;
                },
                label: function(context) {
                  const item = tabua[context.dataIndex];
                  if (context.datasetIndex === 0 && item.mare_mais_alta) {
                    return `Alta: ${item.mare_mais_alta.altura_m}m às ${item.mare_mais_alta.hora}`;
                  } else if (context.datasetIndex === 1 && item.mare_mais_baixa) {
                    return `Baixa: ${item.mare_mais_baixa.altura_m}m às ${item.mare_mais_baixa.hora}`;
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Dia do Mês',
                font: {
                  size: 11
                }
              },
              grid: {
                color: '#f3f4f6'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Altura (m)',
                font: {
                  size: 11
                }
              },
              grid: {
                color: '#f3f4f6'
              },
              beginAtZero: false
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    }

    function gerarTabelaMares(tabua) {
      const tbody = document.getElementById('mare-table-body');
      tbody.innerHTML = '';
      
      tabua.forEach(item => {
        const row = document.createElement('tr');
        
        const altaInfo = item.mare_mais_alta ? 
          `<span class="mare-alta">${item.mare_mais_alta.altura_m}m</span>` : 
          '<span style="color: var(--gray-400);">--</span>';
        
        const altaHora = item.mare_mais_alta ? 
          item.mare_mais_alta.hora : 
          '<span style="color: var(--gray-400);">--</span>';
        
        const baixaInfo = item.mare_mais_baixa ? 
          `<span class="mare-baixa">${item.mare_mais_baixa.altura_m}m</span>` : 
          '<span style="color: var(--gray-400);">--</span>';
        
        const baixaHora = item.mare_mais_baixa ? 
          item.mare_mais_baixa.hora : 
          '<span style="color: var(--gray-400);">--</span>';
        
        row.innerHTML = `
          <td><strong>${item.dia}</strong></td>
          <td>${altaInfo}</td>
          <td>${altaHora}</td>
          <td>${baixaInfo}</td>
          <td>${baixaHora}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function buscarAlertas(cidade) {
      let url = `/alertas_alagamento?cidade=${encodeURIComponent(cidade)}`;
      
      if (coordenadasSelecionadas) {
        url += `&lat=${coordenadasSelecionadas.lat}&lon=${coordenadasSelecionadas.lon}`;
      }
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.analise_risco) {
            exibirAlertas(data.analise_risco);
          }
        })
        .catch(err => {
          console.error('Erro ao buscar alertas:', err);
        });
    }

    function exibirAlertas(analise) {
      const container = document.getElementById('alertas-container');
      const content = document.getElementById('alertas-content');
      
      const nivelClass = `alerta-${analise.nivel.toLowerCase()}`;
      const icone = analise.nivel === 'Alto' ? 'fas fa-exclamation-triangle' : 
                   analise.nivel === 'Moderado' ? 'fas fa-exclamation-circle' : 
                   'fas fa-check-circle';
      
      content.innerHTML = `
        <div class="alerta ${nivelClass}">
          <div class="alerta-titulo">
            <i class="${icone}"></i>
            Risco: ${analise.nivel}
          </div>
          <div class="alerta-descricao">
            <p><strong>Recomendação:</strong> ${analise.recomendacao}</p>
            ${analise.fatores.length > 0 ? `
              <p style="margin-top: 0.5rem;"><strong>Fatores:</strong> ${analise.fatores.join(', ')}</p>
            ` : ''}
          </div>
        </div>
      `;
      
      container.style.display = 'block';
      container.classList.add('slide-up');
    }

    // --- FUNÇÕES AUXILIARES ---
    function getNomeMes(numero) {
      const meses = [
        '', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      return meses[numero];
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', function() {
      // Form de clima
      document.getElementById('clima-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const cidade = document.getElementById('cidade').value;
        fetchClima(`/clima?cidade=${encodeURIComponent(cidade)}`);
      });
      
      // Botão de gerar tábua de marés
      document.getElementById('gerar-tabua').addEventListener('click', gerarTabuaMares);
      
      // Input de cidade de marés
      document.getElementById('cidade-mare').addEventListener('input', function(e) {
        cidadeSelecionada = e.target.value;
        coordenadasSelecionadas = null;
      });
      
      // Inicializar mapa do clima
      initMap();
      
      // Carregar clima inicial
      fetchClima('/clima?cidade=Recife');
    });
  </script>
</body>
</html>

